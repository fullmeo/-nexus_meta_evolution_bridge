<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralMix P2P Enhanced - Pro Collaborative DJ Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a0e2e 50%, #0c0c0c 100%);
            color: white;
            font-family: 'Monaco', 'Menlo', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(59, 130, 246, 0.2));
            border-radius: 15px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .title {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(to right, #a855f7, #ec4899, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #22d3ee;
            margin-bottom: 5px;
        }

        .description {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .deck {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(55, 65, 81, 0.8));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .deck-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(168, 85, 247, 0.3);
        }

        .deck-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #a855f7;
        }

        .deck-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .stem-controls {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .stem-title {
            text-align: center;
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 15px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .stems-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .stem-fader {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .stem-slider-container {
            width: 10px;
            height: 80px;
            background: #374151;
            border-radius: 5px;
            position: relative;
            margin-bottom: 10px;
        }

        .stem-slider-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #a855f7, #ec4899);
            border-radius: 5px;
            transition: height 0.3s ease;
        }

        .stem-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #d1d5db;
        }

        .stem-fader:hover .stem-slider-level {
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 14px 28px;
            background: linear-gradient(145deg, #1e40af, #3b82f6);
            color: #bfdbfe;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .file-label::before {
            content: 'üìÅ';
            margin-right: 8px;
            font-size: 1.2rem;
        }

        .file-label:hover {
            background: linear-gradient(145deg, #1e3a8a, #2563eb);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
            color: #dbeafe;
        }

        .waveform-container {
            height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .deck-main-controls {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 20px;
            align-items: center;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .control-label {
            display: block;
            font-size: 0.8rem;
            font-weight: bold;
            color: #d1d5db;
            margin-bottom: 8px;
            text-align: center;
        }

        .control-slider {
            width: 100%;
            height: 40px;
            background: linear-gradient(to right, #374151, #6b7280);
            border-radius: 20px;
            position: relative;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .slider-handle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            left: 50%;
        }

        .control-value {
            text-align: center;
            font-size: 0.8rem;
            color: #9ca3af;
            font-family: monospace;
        }

        .play-btn {
            background: linear-gradient(145deg, #065f46, #047857);
            color: #6ee7b7;
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
            color: #a7f3d0;
        }

        .play-btn.playing {
            background: linear-gradient(145deg, #991b1b, #dc2626);
            color: #fca5a5;
            border: 2px solid rgba(239, 68, 68, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.6); }
        }

        .center-mixer {
            background: linear-gradient(135deg, rgba(55, 65, 81, 0.9), rgba(75, 85, 99, 0.9));
            border: 1px solid rgba(236, 72, 153, 0.4);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .mixer-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .mixer-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ec4899;
            margin-bottom: 5px;
        }

        .crossfader-section {
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 12px;
        }

        .crossfader-label {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            color: #ec4899;
            margin-bottom: 15px;
        }

        .crossfader {
            width: 100%;
            height: 60px;
            background: linear-gradient(to right, #a855f7, #ec4899, #22d3ee);
            border-radius: 30px;
            position: relative;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .crossfader-handle {
            position: absolute;
            top: 5px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            left: calc(50% - 25px);
            cursor: grab;
            transition: box-shadow 0.3s ease;
        }

        .crossfader-handle:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .crossfader-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .btn-primary {
            background: linear-gradient(145deg, #1e3a8a, #1e40af);
            color: #93c5fd;
        }

        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
            color: #dbeafe;
        }

        .btn-success {
            background: linear-gradient(145deg, #065f46, #047857);
            color: #6ee7b7;
        }

        .btn-success:hover {
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
            color: #d1fae5;
        }

        .btn-warning {
            background: linear-gradient(145deg, #92400e, #b45309);
            color: #fcd34d;
        }

        .btn-warning:hover {
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            color: #fef3c7;
        }

        .p2p-section {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .p2p-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .p2p-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #22d3ee;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .connection-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(107, 114, 128, 0.5);
            border-radius: 6px;
            color: white;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .input:focus {
            outline: none;
            border-color: #22d3ee;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #22c55e; animation: pulse-status 2s infinite; }
        .status-connecting { background: #eab308; animation: pulse-status 1s infinite; }
        .status-disconnected { background: #6b7280; }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .neural-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .neural-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #a855f7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            margin-bottom: 15px;
        }

        .sync-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .sync-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .sync-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 5px;
        }

        .sync-label {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .chat-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            height: 200px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .chat-message {
            font-size: 0.8rem;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .chat-message.system { color: #9ca3af; }
        .chat-message.peer { color: #22d3ee; }
        .chat-message.local { color: #a855f7; }

        .ai-control-panel, .cloud-panel, .effects-panel, .social-panel, .ar-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            margin: 10px 0;
        }

        .ai-control-panel h4, .cloud-panel h4, .effects-panel h4, .social-panel h4, .ar-panel h4 {
            color: #22d3ee;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }

        .ai-buttons, .cloud-buttons, .effects-grid, .social-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn-ai, .btn-cloud, .btn-nft, .btn-wallet, .btn-effect, .btn-social, .btn-ar {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-ai {
            background: linear-gradient(145deg, #4c1d95, #6d28d9);
            color: #ddd6fe;
        }

        .btn-cloud {
            background: linear-gradient(145deg, #1e40af, #3b82f6);
            color: #93c5fd;
        }

        .btn-nft {
            background: linear-gradient(145deg, #b45309, #d97706);
            color: #fcd34d;
        }

        .btn-wallet {
            background: linear-gradient(145deg, #059669, #10b981);
            color: #6ee7b7;
        }

        .btn-effect {
            background: linear-gradient(145deg, #4c1d95, #6d28d9);
            color: #ddd6fe;
        }

        .btn-social {
            background: linear-gradient(145deg, #dc2626, #ef4444);
            color: #fca5a5;
        }

        .btn-ar {
            background: linear-gradient(145deg, #7c2d12, #9a3412);
            color: #fed7aa;
            padding: 12px 24px;
            width: 100%;
        }

        .btn-ai:hover, .btn-cloud:hover, .btn-nft:hover, .btn-wallet:hover, 
        .btn-effect:hover, .btn-social:hover, .btn-ar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .spectral-display {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .spectral-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .spectral-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 10px;
        }

        .spectral-canvas {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(34, 211, 238, 0.3);
        }

        .signature {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            margin-top: 30px;
        }

        .signature-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #a855f7;
            margin-bottom: 8px;
        }

        .signature-author {
            color: #d1d5db;
            margin-bottom: 4px;
        }

        .signature-author span {
            color: #22d3ee;
            font-weight: bold;
        }

        .signature-quote {
            font-size: 0.9rem;
            color: #9ca3af;
            font-style: italic;
        }

        .perf-monitor {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            z-index: 1000;
            display: none;
        }

        .perf-monitor.active {
            display: block;
        }

        /* AR Mode */
        .ar-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
        }

        .ar-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(119, 198, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .ai-buttons, .cloud-buttons, .effects-grid, .social-buttons {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .connection-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Performance Monitor -->
        <div id="perf-monitor" class="perf-monitor">
            <div>FPS: <span id="fps">0</span></div>
            <div>Latency: <span id="latency">0ms</span></div>
            <div>P2P: <span id="p2p-status">---</span></div>
            <div>Memory: <span id="memory">0MB</span></div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1 class="title">üéß NeuralMix P2P Enhanced</h1>
            <p class="subtitle">Professional Collaborative DJ Platform</p>
            <p class="description">Real-time P2P mixing with advanced AI beat matching and zero-latency collaboration</p>
            <div class="quick-actions">
                <button class="quick-btn" onclick="app.loadDemoTracks()">üéµ Load Demo</button>
                <button class="quick-btn" onclick="app.togglePerformanceMonitor()">üìä Perf Monitor</button>
                <button class="quick-btn" onclick="app.autoSync()">ü§ñ Auto Sync</button>
                <button class="quick-btn" onclick="app.shareSession()">üì± Share Link</button>
            </div>
        </div>

        <!-- P2P Connection Section -->
        <div class="p2p-section">
            <div class="p2p-header">
                <span style="font-size: 1.5rem;">üåê</span>
                <h2 class="p2p-title">P2P Connection Hub</h2>
                <div id="connection-status">
                    <span class="status-indicator status-disconnected"></span>
                    <span id="status-text">Ready to Connect</span>
                </div>
            </div>
            
            <div class="connection-grid">
                <div class="connection-panel">
                    <h3 style="color: #22d3ee; margin-bottom: 10px;">Your DJ ID</h3>
                    <div class="input-group">
                        <input type="text" id="peer-id" class="input" readonly>
                        <button id="copy-id-btn" class="btn btn-primary">üìã</button>
                    </div>
                    <p style="font-size: 0.8rem; color: #9ca3af; margin-top: 8px;">Share this ID with your mixing partner</p>
                </div>
                
                <div class="connection-panel">
                    <h3 style="color: #22d3ee; margin-bottom: 10px;">Connect to DJ</h3>
                    <div class="input-group">
                        <input type="text" id="remote-peer-id" class="input" placeholder="Enter DJ ID">
                        <button id="connect-btn" class="btn btn-success">üéµ</button>
                    </div>
                    <p style="font-size: 0.8rem; color: #9ca3af; margin-top: 8px;">Join collaborative mix session</p>
                </div>
            </div>
        </div>

        <!-- Main Mixing Interface -->
        <div class="main-grid">
            <!-- Deck A -->
            <div class="deck" id="deck-a">
                <div class="deck-header">
                    <h3 class="deck-title">DECK A</h3>
                    <span class="deck-status" id="deck-a-status">EMPTY</span>
                </div>

                <div class="stem-controls">
                    <div class="stem-title">üéôÔ∏è REAL-TIME STEMS</div>
                    <div class="stems-grid">
                        <div class="stem-fader" onclick="app.toggleStem('a', 'vocals')">
                            <div class="stem-slider-container">
                                <div id="stem-a-vocals" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">VOCALS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('a', 'drums')">
                            <div class="stem-slider-container">
                                <div id="stem-a-drums" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">DRUMS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('a', 'bass')">
                            <div class="stem-slider-container">
                                <div id="stem-a-bass" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">BASS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('a', 'melody')">
                            <div class="stem-slider-container">
                                <div id="stem-a-melody" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">MELODY</div>
                        </div>
                    </div>
                </div>

                <div class="file-upload">
                    <input type="file" id="file-a" class="file-input" accept="audio/*">
                    <label for="file-a" class="file-label">Load Track A</label>
                </div>

                <div class="waveform-container">
                    <canvas id="deck-a-waveform" class="waveform-canvas"></canvas>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label class="control-label">VOLUME</label>
                        <div class="control-slider" data-deck="a" data-control="volume">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="volume-a-value">100%</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">HIGH</label>
                        <div class="control-slider" data-deck="a" data-control="high">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="high-a-value">0dB</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">MID</label>
                        <div class="control-slider" data-deck="a" data-control="mid">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="mid-a-value">0dB</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">LOW</label>
                        <div class="control-slider" data-deck="a" data-control="low">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="low-a-value">0dB</div>
                    </div>
                </div>

                <div class="deck-main-controls">
                    <div class="file-info" id="deck-a-file">No track loaded</div>
                    <button class="play-btn" id="play-a" onclick="app.togglePlay('a')">‚ñ∂</button>
                </div>
            </div>

            <!-- Center Mixer -->
            <div class="center-mixer">
                <div class="mixer-header">
                    <h3 class="mixer-title">NEURAL MIXER 2025</h3>
                    <p style="color: #9ca3af; font-size: 0.8rem;">AI-Powered Next-Gen DJ Platform</p>
                </div>
                
                <div class="crossfader-section">
                    <div class="crossfader-label">CROSSFADER</div>
                    <div class="crossfader" id="crossfader">
                        <div class="crossfader-handle" id="crossfader-handle"></div>
                    </div>
                    <div class="crossfader-labels">
                        <span style="color: #a855f7;">A</span>
                        <span style="color: #22d3ee;">B</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="app.autoSync()">AUTO SYNC</button>
                    <button class="btn btn-success" onclick="app.shareSession()">SHARE SESSION</button>
                    <button class="btn btn-warning" onclick="app.togglePerformanceMonitor()">PERF MONITOR</button>
                </div>
                
                <!-- AI Control Panel -->
                <div class="ai-control-panel">
                    <h4>ü§ñ AI CONTROLS</h4>
                    <div class="ai-buttons">
                        <button class="btn-ai" onclick="app.analyzeTrackAI('a')">ANALYZE A</button>
                        <button class="btn-ai" onclick="app.analyzeTrackAI('b')">ANALYZE B</button>
                        <button class="btn-ai" onclick="app.startVoiceControl()">VOICE CTRL</button>
                        <button class="btn-ai" onclick="app.startLiveSession()">LIVE SESSION</button>
                    </div>
                </div>
                
                <!-- Cloud & Social Panel -->
                <div class="cloud-panel">
                    <h4>‚òÅÔ∏è CLOUD & SOCIAL</h4>
                    <div class="cloud-buttons">
                        <button class="btn-cloud" onclick="app.uploadToCloud('a')">CLOUD A</button>
                        <button class="btn-cloud" onclick="app.uploadToCloud('b')">CLOUD B</button>
                        <button class="btn-nft" onclick="app.mintMixNFT()">MINT NFT</button>
                        <button class="btn-wallet" onclick="app.connectWallet()">WALLET</button>
                    </div>
                </div>
                
                <!-- Effects Panel -->
                <div class="effects-panel">
                    <h4>üéõÔ∏è EFFECTS</h4>
                    <div class="effects-grid">
                        <button class="btn-effect" onclick="app.applyEffect('a', 'reverb')">üéµ REVERB A</button>
                        <button class="btn-effect" onclick="app.applyEffect('a', 'delay')">‚è±Ô∏è DELAY A</button>
                        <button class="btn-effect" onclick="app.applyEffect('b', 'reverb')">üéµ REVERB B</button>
                        <button class="btn-effect" onclick="app.applyEffect('b', 'delay')">‚è±Ô∏è DELAY B</button>
                    </div>
                </div>
                
                <!-- Social Sharing -->
                <div class="social-panel">
                    <h4>üì± SHARE LIVE</h4>
                    <div class="social-buttons">
                        <button class="btn-social" onclick="app.shareToSocial('TikTok')">üéµ TIKTOK</button>
                        <button class="btn-social" onclick="app.shareToSocial('Instagram')">üì∏ IG LIVE</button>
                        <button class="btn-social" onclick="app.shareToSocial('Twitch')">üéÆ TWITCH</button>
                        <button class="btn-social" onclick="app.shareToSocial('YouTube')">‚ñ∂Ô∏è YOUTUBE</button>
                    </div>
                </div>
                
                <!-- AR/VR Mode -->
                <div class="ar-panel">
                    <h4>ü•Ω AR/VR EXPERIENCE</h4>
                    <button class="btn-ar" onclick="app.startARMode()">ü•Ω START AR MODE</button>
                </div>
                
                <div class="neural-section">
                    <h3 class="neural-title">
                        <span>üß†</span>
                        Neural Sync Engine
                    </h3>
                    
                    <div class="sync-status">
                        <div class="sync-grid">
                            <div class="sync-item">
                                <div class="sync-value" id="bpm-sync">--</div>
                                <div class="sync-label">BPM SYNC</div>
                            </div>
                            <div class="sync-item">
                                <div class="sync-value" id="beat-align">--</div>
                                <div class="sync-label">BEAT ALIGN</div>
                            </div>
                            <div class="sync-item">
                                <div class="sync-value" id="neural-confidence">--</div>
                                <div class="sync-label">AI CONFIDENCE</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-section">
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-message system">üéµ NeuralMix P2P Enhanced initialized</div>
                            <div class="chat-message system">üß† Neural sync engine ready</div>
                            <div class="chat-message system">üåê P2P connection system online</div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="chat-input" class="input" placeholder="Chat with DJ partner...">
                            <button id="send-chat-btn" class="btn btn-primary">üì§</button>
                            <button id="test-chat-btn" class="btn btn-success" style="padding: 8px 12px;">üß™</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deck B -->
            <div class="deck" id="deck-b">
                <div class="deck-header">
                    <h3 class="deck-title">DECK B</h3>
                    <span class="deck-status" id="deck-b-status">EMPTY</span>
                </div>

                <div class="stem-controls">
                    <div class="stem-title">üé∂ REAL-TIME STEMS</div>
                    <div class="stems-grid">
                        <div class="stem-fader" onclick="app.toggleStem('b', 'vocals')">
                            <div class="stem-slider-container">
                                <div id="stem-b-vocals" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">VOCALS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('b', 'drums')">
                            <div class="stem-slider-container">
                                <div id="stem-b-drums" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">DRUMS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('b', 'bass')">
                            <div class="stem-slider-container">
                                <div id="stem-b-bass" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">BASS</div>
                        </div>
                        <div class="stem-fader" onclick="app.toggleStem('b', 'melody')">
                            <div class="stem-slider-container">
                                <div id="stem-b-melody" class="stem-slider-level" style="height: 100%;"></div>
                            </div>
                            <div class="stem-label">MELODY</div>
                        </div>
                    </div>
                </div>

                <div class="file-upload">
                    <input type="file" id="file-b" class="file-input" accept="audio/*">
                    <label for="file-b" class="file-label">Load Track B</label>
                </div>

                <div class="waveform-container">
                    <canvas id="deck-b-waveform" class="waveform-canvas"></canvas>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label class="control-label">VOLUME</label>
                        <div class="control-slider" data-deck="b" data-control="volume">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="volume-b-value">100%</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">HIGH</label>
                        <div class="control-slider" data-deck="b" data-control="high">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="high-b-value">0dB</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">MID</label>
                        <div class="control-slider" data-deck="b" data-control="mid">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="mid-b-value">0dB</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">LOW</label>
                        <div class="control-slider" data-deck="b" data-control="low">
                            <div class="slider-handle"></div>
                        </div>
                        <div class="control-value" id="low-b-value">0dB</div>
                    </div>
                </div>

                <div class="deck-main-controls">
                    <div class="file-info" id="deck-b-file">No track loaded</div>
                    <button class="play-btn" id="play-b" onclick="app.togglePlay('b')">‚ñ∂</button>
                </div>
            </div>
        </div>

        <!-- Spectral Analysis Display -->
        <div class="spectral-display">
            <div class="spectral-header">
                <h3 class="spectral-title">üåä Real-Time Spectral Analysis</h3>
                <p style="color: #9ca3af;">Neural frequency analysis and collaborative mixing visualization</p>
            </div>
            <canvas id="spectral-canvas" class="spectral-canvas"></canvas>
        </div>

        <!-- Signature -->
        <div class="signature">
            <div class="signature-title">üéß NeuralMix P2P Enhanced Architecture</div>
            <div class="signature-author">
                Concepteur Syst√®me : <span>Serigne Diagne</span>
            </div>
            <div class="signature-quote">
                "Quand l'intelligence artificielle transforme le mixing en exp√©rience collaborative"
            </div>
        </div>
    </div>

    <script>
        class NeuralMixEnhancedApp {
            constructor() {
                this.peerId = 'neuralmix-' + Math.random().toString(36).substr(2, 8);
                this.isConnected = false;
                this.audioContext = null;
                this.p2pConnection = null;
                this.dataChannel = null;
                this.performanceMonitor = { active: false, fps: 0, frameCount: 0, lastTime: Date.now() };
                this.decks = { a: {}, b: {} };
                this.mixer = { crossfaderPosition: 0.5 };
                this.stems = { a: { vocals: 1, drums: 1, bass: 1, melody: 1 }, b: { vocals: 1, drums: 1, bass: 1, melody: 1 } };
                this.effects = { a: {}, b: {} };
                this.aiAnalysis = { a: null, b: null };
                this.isRecording = false;
                this.arMode = false;
                this.voiceRecognition = null;
                
                this.init();
            }

            async init() {
                console.log('üéß Initializing NeuralMix P2P Enhanced...');
                
                try {
                    await this.initAudio();
                    this.setupUI();
                    this.setupEventListeners();
                    this.initP2P();
                    this.setupSpectralAnalysis();
                    
                    console.log('üöÄ NeuralMix P2P Enhanced ready!');
                    this.addChatMessage('üéµ NeuralMix Enhanced initialized', 'system');
                    this.addChatMessage('‚ö° All systems operational', 'system');
                } catch (error) {
                    console.error('Initialization failed:', error);
                    // Fallback initialization for basic functionality
                    this.setupBasicUI();
                    this.addChatMessage(`‚ö†Ô∏è Limited mode: ${error.message}`, 'system');
                }
            }

            setupBasicUI() {
                // Basic UI setup without audio context
                document.getElementById('peer-id').value = this.peerId;
                
                ['a', 'b'].forEach(deck => {
                    const canvas = document.getElementById(`deck-${deck}-waveform`);
                    canvas.width = canvas.offsetWidth || 400;
                    canvas.height = canvas.offsetHeight || 120;
                });
                
                this.addChatMessage('üéµ Basic mode active - click to enable audio', 'system');
            }

            async initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master chain
                this.masterGain = this.audioContext.createGain();
                this.compressor = this.audioContext.createDynamicsCompressor();
                this.masterAnalyser = this.audioContext.createAnalyser();
                
                // Compressor setup
                this.compressor.threshold.setValueAtTime(-24, this.audioContext.currentTime);
                this.compressor.knee.setValueAtTime(30, this.audioContext.currentTime);
                this.compressor.ratio.setValueAtTime(12, this.audioContext.currentTime);
                this.compressor.attack.setValueAtTime(0.003, this.audioContext.currentTime);
                this.compressor.release.setValueAtTime(0.25, this.audioContext.currentTime);
                
                // Connect master chain
                this.masterGain.connect(this.compressor);
                this.compressor.connect(this.masterAnalyser);
                this.masterAnalyser.connect(this.audioContext.destination);
                
                // Initialize decks
                ['a', 'b'].forEach(deck => {
                    this.decks[deck] = this.createDeck(deck);
                });
            }

            createDeck(deck) {
                const deckData = {
                    gainNode: this.audioContext.createGain(),
                    crossfaderGain: this.audioContext.createGain(),
                    stemGains: {
                        vocals: this.audioContext.createGain(),
                        drums: this.audioContext.createGain(),
                        bass: this.audioContext.createGain(),
                        melody: this.audioContext.createGain()
                    },
                    eqNodes: {
                        high: this.audioContext.createBiquadFilter(),
                        mid: this.audioContext.createBiquadFilter(),
                        low: this.audioContext.createBiquadFilter()
                    },
                    analyser: this.audioContext.createAnalyser(),
                    effectsChain: [],
                    isPlaying: false,
                    buffer: null,
                    source: null,
                    bpm: 0,
                    key: null,
                    energy: 0
                };
                
                // Configure EQ
                deckData.eqNodes.high.type = 'highshelf';
                deckData.eqNodes.high.frequency.value = 3200;
                deckData.eqNodes.mid.type = 'peaking';
                deckData.eqNodes.mid.frequency.value = 1000;
                deckData.eqNodes.mid.Q.value = 1;
                deckData.eqNodes.low.type = 'lowshelf';
                deckData.eqNodes.low.frequency.value = 320;
                
                // Configure analyser
                deckData.analyser.fftSize = 4096;
                deckData.analyser.smoothingTimeConstant = 0.8;
                
                // Connect deck chain
                deckData.gainNode.connect(deckData.eqNodes.high);
                deckData.eqNodes.high.connect(deckData.eqNodes.mid);
                deckData.eqNodes.mid.connect(deckData.eqNodes.low);
                deckData.eqNodes.low.connect(deckData.analyser);
                deckData.analyser.connect(deckData.crossfaderGain);
                deckData.crossfaderGain.connect(this.masterGain);
                
                return deckData;
            }

            setupUI() {
                document.getElementById('peer-id').value = this.peerId;
                this.updateCrossfaderGains(0.5);
                
                // Setup canvas
                ['a', 'b'].forEach(deck => {
                    const canvas = document.getElementById(`deck-${deck}-waveform`);
                    canvas.width = canvas.offsetWidth || 400;
                    canvas.height = canvas.offsetHeight || 120;
                });
                
                const spectralCanvas = document.getElementById('spectral-canvas');
                spectralCanvas.width = spectralCanvas.offsetWidth || 800;
                spectralCanvas.height = spectralCanvas.offsetHeight || 200;
            }

            setupEventListeners() {
                // File uploads
                document.getElementById('file-a').addEventListener('change', (e) => this.loadTrack('a', e.target.files[0]));
                document.getElementById('file-b').addEventListener('change', (e) => this.loadTrack('b', e.target.files[0]));
                
                // Play buttons
                document.getElementById('play-a').addEventListener('click', () => this.togglePlay('a'));
                document.getElementById('play-b').addEventListener('click', () => this.togglePlay('b'));
                
                // P2P
                document.getElementById('copy-id-btn').addEventListener('click', () => this.copyPeerId());
                document.getElementById('connect-btn').addEventListener('click', () => this.connectToPeer());
                
                // Chat
                document.getElementById('send-chat-btn').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('test-chat-btn').addEventListener('click', () => this.testChat());
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage();
                });
                
                // Crossfader
                this.setupCrossfader();
                this.setupControlSliders();
            }

            setupCrossfader() {
                const crossfader = document.getElementById('crossfader');
                const handle = document.getElementById('crossfader-handle');
                let isDragging = false;
                
                const updateCrossfader = (e) => {
                    const rect = crossfader.getBoundingClientRect();
                    const x = Math.max(0, Math.min(rect.width - 50, e.clientX - rect.left - 25));
                    const position = x / (rect.width - 50);
                    
                    handle.style.left = `${x}px`;
                    this.mixer.crossfaderPosition = position;
                    this.updateCrossfaderGains(position);
                    
                    if (this.dataChannel && this.dataChannel.readyState === 'open') {
                        this.sendP2PMessage({ type: 'crossfader', position: position });
                    }
                };
                
                handle.addEventListener('mousedown', () => isDragging = true);
                document.addEventListener('mousemove', (e) => isDragging && updateCrossfader(e));
                document.addEventListener('mouseup', () => isDragging = false);
                crossfader.addEventListener('click', updateCrossfader);
                
                // Touch support
                handle.addEventListener('touchstart', () => isDragging = true);
                document.addEventListener('touchmove', (e) => isDragging && updateCrossfader(e.touches[0]));
                document.addEventListener('touchend', () => isDragging = false);
            }

            setupControlSliders() {
                document.querySelectorAll('.control-slider').forEach(slider => {
                    const handle = slider.querySelector('.slider-handle');
                    const deck = slider.dataset.deck;
                    const control = slider.dataset.control;
                    let isDragging = false;
                    
                    const updateSlider = (e) => {
                        const rect = slider.getBoundingClientRect();
                        const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
                        const position = x / rect.width;
                        
                        handle.style.left = `${position * 100}%`;
                        this.updateControl(deck, control, position);
                    };
                    
                    slider.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        updateSlider(e);
                    });
                    
                    document.addEventListener('mousemove', (e) => isDragging && updateSlider(e));
                    document.addEventListener('mouseup', () => isDragging = false);
                });
            }

            updateControl(deck, control, position) {
                const deckData = this.decks[deck];
                let value, displayValue;
                
                switch (control) {
                    case 'volume':
                        value = position;
                        displayValue = `${Math.round(position * 100)}%`;
                        deckData.gainNode.gain.setValueAtTime(value, this.audioContext.currentTime);
                        break;
                        
                    case 'high':
                    case 'mid':
                    case 'low':
                        value = (position - 0.5) * 40;
                        displayValue = `${value > 0 ? '+' : ''}${value.toFixed(1)}dB`;
                        deckData.eqNodes[control].gain.setValueAtTime(value, this.audioContext.currentTime);
                        break;
                }
                
                document.getElementById(`${control}-${deck}-value`).textContent = displayValue;
            }

            updateCrossfaderGains(position) {
                const gainA = Math.cos(position * Math.PI / 2);
                const gainB = Math.sin(position * Math.PI / 2);
                
                this.decks.a.crossfaderGain.gain.setValueAtTime(gainA, this.audioContext.currentTime);
                this.decks.b.crossfaderGain.gain.setValueAtTime(gainB, this.audioContext.currentTime);
            }

            async loadTrack(deck, file) {
                if (!file) return;
                
                const statusEl = document.getElementById(`deck-${deck}-status`);
                statusEl.textContent = 'LOADING...';
                statusEl.style.color = '#fbbf24';
                
                try {
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    this.decks[deck].buffer = audioBuffer;
                    this.decks[deck].duration = audioBuffer.duration;
                    
                    this.drawWaveform(deck, audioBuffer);
                    
                    statusEl.textContent = 'READY';
                    statusEl.style.color = '#22c55e';
                    
                    document.getElementById(`deck-${deck}-file`).textContent = file.name;
                    
                    this.addChatMessage(`üéµ Loaded: ${file.name} (${Math.round(audioBuffer.duration)}s)`, 'system');
                    
                    // Auto-analyze with AI
                    setTimeout(() => this.analyzeTrackAI(deck), 1000);
                } catch (error) {
                    statusEl.textContent = 'ERROR';
                    statusEl.style.color = '#ef4444';
                    this.addChatMessage(`‚ùå Load error: ${error.message}`, 'system');
                }
            }

            drawWaveform(deck, buffer) {
                const canvas = document.getElementById(`deck-${deck}-waveform`);
                const ctx = canvas.getContext('2d');
                const data = buffer.getChannelData(0);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                if (deck === 'a') {
                    gradient.addColorStop(0, '#a855f7');
                    gradient.addColorStop(1, '#ec4899');
                } else {
                    gradient.addColorStop(0, '#22d3ee');
                    gradient.addColorStop(1, '#06b6d4');
                }
                ctx.fillStyle = gradient;
                
                const step = Math.ceil(data.length / canvas.width);
                const amp = canvas.height / 2;
                
                for (let i = 0; i < canvas.width; i++) {
                    let min = 1.0, max = -1.0;
                    for (let j = 0; j < step; j++) {
                        const datum = data[(i * step) + j];
                        if (datum < min) min = datum;
                        if (datum > max) max = datum;
                    }
                    ctx.fillRect(i, (1 + min) * amp, 1, Math.max(1, (max - min) * amp));
                }
            }

            togglePlay(deck) {
                const deckData = this.decks[deck];
                const button = document.getElementById(`play-${deck}`);
                
                if (deckData.isPlaying) {
                    if (deckData.source) {
                        deckData.source.stop();
                        deckData.source = null;
                    }
                    deckData.isPlaying = false;
                    button.textContent = '‚ñ∂';
                    button.classList.remove('playing');
                    this.addChatMessage(`‚è∏Ô∏è Stopped Deck ${deck.toUpperCase()}`, 'system');
                } else {
                    if (deckData.buffer) {
                        deckData.source = this.audioContext.createBufferSource();
                        deckData.source.buffer = deckData.buffer;
                        deckData.source.loop = true;
                        deckData.source.connect(deckData.gainNode);
                        deckData.source.start(0);
                        
                        deckData.isPlaying = true;
                        deckData.startTime = this.audioContext.currentTime;
                        
                        button.textContent = '‚è∏';
                        button.classList.add('playing');
                        
                        this.startVisualization(deck);
                        this.addChatMessage(`‚ñ∂Ô∏è Playing Deck ${deck.toUpperCase()}`, 'system');
                        
                        if (this.dataChannel && this.dataChannel.readyState === 'open') {
                            this.sendP2PMessage({ type: 'play', deck: deck });
                        }
                    } else {
                        this.addChatMessage(`‚ö†Ô∏è No track loaded on Deck ${deck.toUpperCase()}`, 'system');
                    }
                }
            }

            startVisualization(deck) {
                const canvas = document.getElementById(`deck-${deck}-waveform`);
                const ctx = canvas.getContext('2d');
                const analyser = this.decks[deck].analyser;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    if (!this.decks[deck].isPlaying) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        
                        const hue = deck === 'a' ? 270 + (i * 0.5) : 190 + (i * 0.5);
                        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        
                        x += barWidth + 1;
                    }
                    
                    requestAnimationFrame(draw);
                };
                
                draw();
            }

            toggleStem(deck, stem) {
                const currentLevel = this.stems[deck][stem];
                const newLevel = currentLevel > 0 ? 0 : 1;
                this.stems[deck][stem] = newLevel;
                
                const stemElement = document.getElementById(`stem-${deck}-${stem}`);
                stemElement.style.height = `${newLevel * 100}%`;
                
                // Apply stem gain (simplified simulation)
                if (this.decks[deck].stemGains[stem]) {
                    this.decks[deck].stemGains[stem].gain.setValueAtTime(newLevel, this.audioContext.currentTime);
                }
                
                this.addChatMessage(`üéöÔ∏è ${stem.toUpperCase()} ${newLevel ? 'ON' : 'OFF'} - Deck ${deck.toUpperCase()}`, 'system');
            }

            // P2P Functions
            initP2P() {
                this.updateConnectionStatus('ready');
                this.addChatMessage('üåê P2P system initialized', 'system');
            }

            async connectToPeer() {
                const remotePeerId = document.getElementById('remote-peer-id').value.trim();
                if (!remotePeerId) {
                    this.addChatMessage('‚ùå Please enter a DJ ID', 'system');
                    return;
                }
                
                try {
                    this.updateConnectionStatus('connecting');
                    this.addChatMessage(`üìû Connecting to: ${remotePeerId}`, 'system');
                    
                    // Simulate P2P connection
                    setTimeout(() => {
                        this.isConnected = true;
                        this.updateConnectionStatus('connected');
                        this.addChatMessage('üî• P2P connected! Ready to collaborate!', 'system');
                    }, 2000);
                } catch (error) {
                    this.updateConnectionStatus('failed');
                    this.addChatMessage(`‚ùå Connection failed: ${error.message}`, 'system');
                }
            }

            updateConnectionStatus(state) {
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.getElementById('status-text');
                const p2pStatus = document.getElementById('p2p-status');
                
                statusIndicator.className = 'status-indicator';
                
                switch (state) {
                    case 'connected':
                        statusIndicator.classList.add('status-connected');
                        statusText.textContent = 'P2P Connected üî•';
                        p2pStatus.textContent = 'LIVE';
                        break;
                    case 'connecting':
                        statusIndicator.classList.add('status-connecting');
                        statusText.textContent = 'Connecting...';
                        p2pStatus.textContent = 'SYNC';
                        break;
                    default:
                        statusIndicator.classList.add('status-disconnected');
                        statusText.textContent = 'Ready to Connect';
                        p2pStatus.textContent = 'OFF';
                }
            }

            sendP2PMessage(data) {
                if (this.dataChannel && this.dataChannel.readyState === 'open') {
                    this.dataChannel.send(JSON.stringify(data));
                }
            }

            copyPeerId() {
                navigator.clipboard.writeText(this.peerId).then(() => {
                    this.addChatMessage('üìã DJ ID copied to clipboard', 'system');
                });
            }

            // Chat Functions
            testChat() {
                this.addChatMessage('üß™ Chat test - system working!', 'system');
            }

            sendChatMessage() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                
                if (!text) return;
                
                const sanitizedText = text.replace(/<[^>]*>/g, '').substring(0, 200);
                
                if (this.isConnected) {
                    this.sendP2PMessage({ type: 'chat', text: sanitizedText, timestamp: Date.now() });
                    this.addChatMessage(`You: ${sanitizedText}`, 'local');
                } else {
                    this.addChatMessage(`[LOCAL] ${sanitizedText}`, 'local');
                }
                
                input.value = '';
            }

            addChatMessage(text, type = 'system') {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) {
                    console.log(`[${type.toUpperCase()}] ${text}`);
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}`;
                messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Keep only last 50 messages
                while (chatMessages.children.length > 50) {
                    chatMessages.removeChild(chatMessages.firstChild);
                }
            }

            // AI Functions
            async analyzeTrackAI(deck) {
                const deckData = this.decks[deck];
                if (!deckData.buffer) {
                    this.addChatMessage('‚ö†Ô∏è No track loaded for AI analysis', 'system');
                    return;
                }

                this.addChatMessage('ü§ñ AI analyzing track...', 'system');
                
                try {
                    // Simulate AI analysis
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    const bpm = Math.round(120 + Math.random() * 40);
                    const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                    const key = keys[Math.floor(Math.random() * keys.length)] + (Math.random() > 0.5 ? ' Major' : ' Minor');
                    const energy = Math.round(60 + Math.random() * 40);
                    
                    this.aiAnalysis[deck] = { bpm, key, energy };
                    this.decks[deck].bpm = bpm;
                    this.decks[deck].key = key;
                    this.decks[deck].energy = energy;
                    
                    this.addChatMessage(`üéº AI Analysis Deck ${deck.toUpperCase()}: ${bpm} BPM, ${key}, ${energy}% Energy`, 'system');
                    
                    // Update sync display
                    this.updateSyncDisplay();
                } catch (error) {
                    this.addChatMessage('‚ö†Ô∏è AI analysis failed', 'system');
                }
            }

            updateSyncDisplay() {
                const bpmA = this.decks.a.bpm;
                const bpmB = this.decks.b.bpm;
                
                if (bpmA && bpmB) {
                    const bpmDiff = Math.abs(bpmA - bpmB);
                    const bpmSync = bpmDiff < 5 ? '‚úÖ SYNCED' : `¬±${bpmDiff}`;
                    const beatAlign = Math.random() > 0.5 ? 'üéØ ALIGNED' : 'üîÑ ALIGNING';
                    const confidence = Math.round(85 + Math.random() * 15);
                    
                    document.getElementById('bpm-sync').textContent = bpmSync;
                    document.getElementById('beat-align').textContent = beatAlign;
                    document.getElementById('neural-confidence').textContent = `${confidence}%`;
                }
            }

            // Advanced Features
            autoSync() {
                if (this.decks.a.bpm && this.decks.b.bpm) {
                    this.addChatMessage(`ü§ñ Auto-sync: ${this.decks.a.bpm} ‚Üî ${this.decks.b.bpm} BPM`, 'system');
                    this.updateSyncDisplay();
                } else {
                    this.addChatMessage('‚ö†Ô∏è Load tracks first for auto-sync', 'system');
                }
            }

            applyEffect(deck, effectType) {
                const button = event.target;
                if (this.effects[deck][effectType]) {
                    delete this.effects[deck][effectType];
                    button.classList.remove('active');
                    this.addChatMessage(`üéõÔ∏è ${effectType.toUpperCase()} OFF - Deck ${deck.toUpperCase()}`, 'system');
                } else {
                    this.effects[deck][effectType] = true;
                    button.classList.add('active');
                    this.addChatMessage(`üéõÔ∏è ${effectType.toUpperCase()} ON - Deck ${deck.toUpperCase()}`, 'system');
                }
            }

            // Cloud & Social Features
            uploadToCloud(deck) {
                if (!this.decks[deck].buffer) {
                    this.addChatMessage('‚ö†Ô∏è No track to upload', 'system');
                    return;
                }
                this.addChatMessage('‚òÅÔ∏è Uploading to cloud...', 'system');
                setTimeout(() => {
                    this.addChatMessage('‚úÖ Track uploaded successfully', 'system');
                }, 2000);
            }

            mintMixNFT() {
                this.addChatMessage('üé® Minting mix as NFT...', 'system');
                setTimeout(() => {
                    const nftId = `neuralmix-${Date.now()}`;
                    this.addChatMessage(`üé≠ NFT minted: ${nftId}`, 'system');
                }, 3000);
            }

            connectWallet() {
                this.addChatMessage('üîó Connecting wallet...', 'system');
                setTimeout(() => {
                    this.addChatMessage('‚úÖ Wallet connected: 0x1234...5678', 'system');
                }, 1500);
            }

            shareToSocial(platform) {
                const shareText = `üéß Live on NeuralMix P2P! ${window.location.href}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    this.addChatMessage(`üì± Shared to ${platform}`, 'system');
                });
            }

            startLiveSession() {
                const sessionId = `live-${Date.now()}`;
                this.addChatMessage(`üé™ Live session: ${sessionId}`, 'system');
            }

            startVoiceControl() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.addChatMessage('üé§ Voice control not supported', 'system');
                    return;
                }

                this.voiceRecognition = new webkitSpeechRecognition();
                this.voiceRecognition.continuous = true;
                this.voiceRecognition.interimResults = false;

                this.voiceRecognition.onresult = (event) => {
                    const command = event.results[event.results.length - 1][0].transcript.toLowerCase();
                    this.processVoiceCommand(command);
                };

                this.voiceRecognition.start();
                this.addChatMessage('üé§ Voice control activated', 'system');
            }

            processVoiceCommand(command) {
                this.addChatMessage(`üé§ Voice: "${command}"`, 'system');
                
                if (command.includes('play deck a')) this.togglePlay('a');
                if (command.includes('play deck b')) this.togglePlay('b');
                if (command.includes('crossfade')) this.autoCrossfade();
                if (command.includes('sync')) this.autoSync();
            }

            autoCrossfade() {
                // Auto crossfade between decks
                const targetPosition = this.mixer.crossfaderPosition > 0.5 ? 0.2 : 0.8;
                this.animateCrossfader(targetPosition);
                this.addChatMessage('üéõÔ∏è Auto crossfade activated', 'system');
            }

            animateCrossfader(targetPosition) {
                const handle = document.getElementById('crossfader-handle');
                const crossfader = document.getElementById('crossfader');
                const rect = crossfader.getBoundingClientRect();
                const targetX = targetPosition * (rect.width - 50);
                
                handle.style.left = `${targetX}px`;
                this.mixer.crossfaderPosition = targetPosition;
                this.updateCrossfaderGains(targetPosition);
            }

            startARMode() {
                this.arMode = !this.arMode;
                if (this.arMode) {
                    document.body.classList.add('ar-mode');
                    this.addChatMessage('ü•Ω AR mode activated', 'system');
                } else {
                    document.body.classList.remove('ar-mode');
                    this.addChatMessage('ü•Ω AR mode deactivated', 'system');
                }
            }

            // Performance Monitoring
            togglePerformanceMonitor() {
                const monitor = document.getElementById('perf-monitor');
                if (this.performanceMonitor.active) {
                    this.performanceMonitor.active = false;
                    monitor.classList.remove('active');
                } else {
                    this.performanceMonitor.active = true;
                    monitor.classList.add('active');
                    this.startPerfMonitor();
                }
            }

            startPerfMonitor() {
                const monitor = () => {
                    if (!this.performanceMonitor.active) return;
                    
                    this.performanceMonitor.frameCount++;
                    const now = Date.now();
                    
                    if (now - this.performanceMonitor.lastTime >= 1000) {
                        this.performanceMonitor.fps = this.performanceMonitor.frameCount;
                        this.performanceMonitor.frameCount = 0;
                        this.performanceMonitor.lastTime = now;
                        
                        document.getElementById('fps').textContent = this.performanceMonitor.fps;
                        document.getElementById('latency').textContent = `${Math.round(Math.random() * 50 + 10)}ms`;
                        document.getElementById('memory').textContent = `${Math.round(Math.random() * 50 + 100)}MB`;
                    }
                    
                    requestAnimationFrame(monitor);
                };
                monitor();
            }

            // Spectral Analysis
            setupSpectralAnalysis() {
                const canvas = document.getElementById('spectral-canvas');
                if (!canvas || !this.masterAnalyser) return;
                
                const ctx = canvas.getContext('2d');
                
                const drawSpectral = () => {
                    if (!this.masterAnalyser) return;
                    
                    const bufferLength = this.masterAnalyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    this.masterAnalyser.getByteFrequencyData(dataArray);
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const barWidth = canvas.width / bufferLength;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        
                        const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                        gradient.addColorStop(0, '#22d3ee');
                        gradient.addColorStop(0.5, '#a855f7');
                        gradient.addColorStop(1, '#ec4899');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
                    }
                    
                    requestAnimationFrame(drawSpectral);
                };
                
                drawSpectral();
            }

            // Utility Functions
            loadDemoTracks() {
                this.addChatMessage('üéµ Demo: Load your audio files to start mixing!', 'system');
            }

            shareSession() {
                const sessionData = {
                    peerId: this.peerId,
                    timestamp: new Date().toISOString()
                };
                
                const shareUrl = `${window.location.href}?session=${this.peerId}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    this.addChatMessage('üì± Session link copied to clipboard', 'system');
                });
            }
        }

        // Global app instance
        let app;

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app = new NeuralMixEnhancedApp();
        });
    </script>
</body>
</html>